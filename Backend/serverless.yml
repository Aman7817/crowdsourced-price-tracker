service: crowdsourced-price-tracker
frameworkVersion: "4"

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-south-1
  environment:
    MONGODB_URI: ${ssm:/cpt/mongoUri}
    JWT_SECRET: ${ssm:/cpt/jwtSecret}
  httpApi:
    cors:          # ‚Üê global CORS only here
      allowedOrigins:
        - https://crowdsourced-price-tracker-gkq7.vercel.app
        - http://localhost:5173
      allowedHeaders:
        - Content-Type
        - Authorization
        - x-api-key
      allowedMethods: "*"
      allowCredentials: true
    authorizers:
      jwtAuthorizer:
        type: request
        functionName: jwtAuthorizer

functions:
  jwtAuthorizer:
    handler: src/auth/jwtAuthorizer.jwtAuthorizer

  registerUser:
    handler: src/handlers/user/registerUser.registerUser
    events:
      - httpApi:
          path: /api/v1/user/register
          method: post

  loginUser:
    handler: src/handlers/user/loginUser.loginUser
    events:
      - httpApi:
          path: /api/v1/user/login
          method: post

  getMe:
    handler: src/handlers/user/getMe.getMe
    events:
      - httpApi:
          path: /api/v1/user/me
          method: get
          authorizer:
            name: jwtAuthorizer

  logOutUser:
    handler: src/handlers/user/logOutUser.logOutUser
    events:
      - httpApi:
          path: /api/v1/user/logout
          method: post
          authorizer:
            name: jwtAuthorizer

  changePassword:
    handler: src/handlers/user/changePassword.changePassword
    events:
      - httpApi:
          path: /api/v1/user/change-password
          method: put
          authorizer:
            name: jwtAuthorizer

  updateAccount:
    handler: src/handlers/user/updateAccountDetails.updateAccountDetails
    events:
      - httpApi:
          path: /api/v1/user/update-account
          method: put
          authorizer:
            name: jwtAuthorizer

  addProduct:
    handler: src/handlers/product/addProduct.addProduct
    events:
      - httpApi:
          path: /api/v1/product
          method: post
          authorizer:
            name: jwtAuthorizer

  getAllProducts:
    handler: src/handlers/product/getAllProducts.getAllProducts
    events:
      - httpApi:
          path: /api/v1/product
          method: get
          authorizer:
            name: jwtAuthorizer

  getProduct:
    handler: src/handlers/product/getProduct.getProduct
    events:
      - httpApi:
          path: /api/v1/product/{id}
          method: get
          authorizer:
            name: jwtAuthorizer

  scanProduct:
    handler: src/handlers/product/scanProduct.scanProduct
    events:
      - httpApi:
          path: /api/v1/product/{id}/scan
          method: post
          authorizer:
            name: jwtAuthorizer

  deleteProduct:
    handler: src/handlers/product/deleteProduct.deleteProduct
    events:
      - httpApi:
          path: /api/v1/product/{id}
          method: delete
          authorizer:
            name: jwtAuthorizer

  getPriceHistory:
    handler: src/handlers/product/getPriceHistory.getPriceHistory
    events:
      - httpApi:
          path: /api/v1/product/{id}/history
          method: get
          authorizer:
            name: jwtAuthorizer

  refreshProducts:
    handler: src/handlers/product/refreshProducts.refreshProducts
    events:
      - httpApi:
          path: /api/v1/product/refresh
          method: post
          authorizer:
            name: jwtAuthorizer

  cronRefreshProducts:
    handler: src/handlers/product/updatePrices.updatePrices
    events:
      - schedule: cron(0 */2 * * ? *)

  createAlert:
    handler: src/handlers/alerts/createAlert.createAlert
    events:
      - httpApi:
          path: /api/v1/alerts
          method: post
          authorizer:
            name: jwtAuthorizer

  getAlerts:
    handler: src/handlers/alerts/getAlerts.getAlerts
    events:
      - httpApi:
          path: /api/v1/alerts
          method: get
          authorizer:
            name: jwtAuthorizer

package:
  individually: true





















# service: crowdsourced-price-tracker

# frameworkVersion: "4"

# provider:
#   name: aws
#   runtime: nodejs20.x
#   region: ap-south-1
#   environment:
#     MONGODB_URI: ${ssm:/cpt/mongoUri}
#     JWT_SECRET: ${ssm:/cpt/jwtSecret}
#   httpApi:
#     cors:
#       cors: true   
#       allowedOrigins:
#         - https://crowdsourced-price-tracker.vercel.app
#         - http://localhost:5173
      
#       allowedHeaders:
#         - Content-Type
#         - Authorization
#         - x-api-key
#       allowedMethods:
#         - OPTIONS
#         - GET
#         - POST
#         - PUT
#         - DELETE
#       allowCredentials: true

#     authorizers:
#       jwtAuthorizer:
#         type: request
#         functionName: jwtAuthorizer
#   # Optional: define deployment bucket if you have S3 permission issues
#   # deploymentBucket: your-existing-s3-bucket-name

# functions:
#   # =======================
#   # AUTHORIZER
#   # =======================
#   jwtAuthorizer:
#     handler: src/auth/jwtAuthorizer.jwtAuthorizer

#   # =======================
#   # USER ROUTES
#   # =======================
#   registerUser:
#     handler: src/handlers/user/registerUser.registerUser
#     events:
#       - httpApi:
#           path: /api/v1/user/register
#           method: post

#   loginUser:
#     handler: src/handlers/user/loginUser.loginUser
#     events:
#       - httpApi:
#           path: /api/v1/user/login
#           method: post

#   getMe:
#     handler: src/handlers/user/getMe.getMe
#     events:
#       - httpApi:
#           path: /api/v1/user/me
#           method: get
#           authorizer:
#             name: jwtAuthorizer

#   logOutUser:
#     handler: src/handlers/user/logOutUser.logOutUser
#     events:
#       - httpApi:
#           path: /api/v1/user/logout
#           method: post
#           authorizer:
#             name: jwtAuthorizer

#   changePassword:
#     handler: src/handlers/user/changePassword.changePassword
#     events:
#       - httpApi:
#           path: /api/v1/user/change-password
#           method: put
#           authorizer:
#             name: jwtAuthorizer

#   updateAccount:
#     handler: src/handlers/user/updateAccountDetails.updateAccountDetails
#     events:
#       - httpApi:
#           path: /api/v1/user/update-account
#           method: put
#           authorizer:
#             name: jwtAuthorizer

#   # =======================
#   # PRODUCT ROUTES
#   # =======================
#   addProduct:
#     handler: src/handlers/product/addProduct.addProduct
#     events:
#       - httpApi:
#           path: /api/v1/product
#           method: post
#           authorizer:
#             name: jwtAuthorizer

#   getAllProducts:
#     handler: src/handlers/product/getAllProducts.getAllProducts
#     events:
#       - httpApi:
#           path: /api/v1/product
#           method: get
#           authorizer:
#             name: jwtAuthorizer

#   getProduct:
#     handler: src/handlers/product/getProduct.getProduct
#     events:
#       - httpApi:
#           path: /api/v1/product/{id}
#           method: get
#           authorizer:
#             name: jwtAuthorizer

#   scanProduct:
#     handler: src/handlers/product/scanProduct.scanProduct
#     events:
#       - httpApi:
#           path: /api/v1/product/{id}/scan
#           method: post
#           authorizer:
#             name: jwtAuthorizer

#   deleteProduct:
#     handler: src/handlers/product/deleteProduct.deleteProduct
#     events:
#       - httpApi:
#           path: /api/v1/product/{id}
#           method: delete
#           authorizer:
#             name: jwtAuthorizer

#   getPriceHistory:
#     handler: src/handlers/product/getPriceHistory.getPriceHistory
#     events:
#       - httpApi:
#           path: /api/v1/product/{id}/history
#           method: get
#           authorizer:
#             name: jwtAuthorizer

#   refreshProducts:
#     handler: src/handlers/product/refreshProducts.refreshProducts
#     events:
#       - httpApi:
#           path: /api/v1/product/refresh
#           method: post
#           authorizer:
#             name: jwtAuthorizer

#   # =======================
#   # CRON JOB (Every 2 hours)
#   # =======================
#   cronRefreshProducts:
#     handler: src/handlers/product/updatePrices.updatePrices
#     events:
#       - schedule: cron(0 */2 * * ? *)

#   # =======================
#   # ALERTS ROUTES
#   # =======================
#   createAlert:
#     handler: src/handlers/alerts/createAlert.createAlert
#     events:
#       - httpApi:
#           path: /api/v1/alerts
#           method: post
#           authorizer:
#             name: jwtAuthorizer

#   getAlerts:
#     handler: src/handlers/alerts/getAlerts.getAlerts
#     events:
#       - httpApi:
#           path: /api/v1/alerts
#           method: get
#           authorizer:
#             name: jwtAuthorizer

# # plugins:
# #   - serverless-webpack

# package:
#   individually: true
